steps:
  - powershell: Write-Host "##vso[task.prependpath]$env:CONDA\Scripts"
    condition: eq(variables['Agent.OS'], 'Windows_NT')
    displayName: 'Add conda to PATH (Windows)'

  - bash: |
      echo "##vso[task.prependpath]$CONDA/bin"
      # https://docs.microsoft.com/en-us/azure/devops/pipelines/ecosystems/anaconda?view=azure-devops&tabs=macos#add-conda-to-your-system-path
      if [ "${{ variables['Agent.OS'] }}" == "Darwin" ]; then
        sudo chown -R $USER $CONDA
      fi
    condition: eq(variables['Agent.OS'], 'Linux')
    displayName: 'Add conda to PATH (Linux)'

  - bash: |
      # https://docs.microsoft.com/en-us/azure/devops/pipelines/ecosystems/anaconda?view=azure-devops&tabs=macos#add-conda-to-your-system-path
      echo "##vso[task.prependpath]$CONDA/bin"
      sudo chown -R $USER $CONDA
    condition: eq(variables['Agent.OS'], 'Darwin')
    displayName: 'Add conda to PATH (Mac)'

  - bash: conda install conda-build --yes
    displayName: 'Installing conda-build'

  - script: |
      pip install --upgrade pip
    displayName: 'Updating pip'

  - script: |
      pip install -r build_tools/build_requirements.txt
      make requirements
    displayName: 'Installing requirements'

  - script: make bdist_wheel
    displayName: 'Building wheel file'

  - bash: |
      mkdir conda
      cd build_tools/azure
      python render_meta.py
      cd -
    displayName: 'Rendering meta.yaml file'

  - script: |
      call activate base
      conda-build --python=$(python.version) conda/
    displayName: 'Building and testing conda distribution (Windows)'

  - script: conda-build --python=$(python.version) conda/
    condition: ne(variables['Agent.OS'], 'Windows_NT')
    displayName: 'Building and testing conda distribution (Linux and Mac)'


