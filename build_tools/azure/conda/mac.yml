# All conda steps need to be sourced befor anything else.
# https://docs.microsoft.com/en-us/azure/devops/pipelines/ecosystems/anaconda?view=azure-devops&tabs=macos#run-pipeline-steps-in-an-anaconda-environment
steps:
  - bash: |
      echo "##vso[task.prependpath]$CONDA/bin"
      sudo chown -R $USER $CONDA
    displayName: 'Add conda to PATH'

  - script: conda install conda-build anaconda-client --yes
    displayName: 'Installing conda-build and anaconda-client'

  - bash: |
      conda create --name build-env python=$(python.version) --file requirements.txt --yes
      source activate build-env
      python -m pip install --upgrade pip
      python -m pip install -r build_tools/build_requirements.txt
    displayName: Creating build environment

  - script: |
      source activate build-env
      make bdist_wheel
    displayName: 'Building wheel file'

  - bash: |
      mkdir conda
      python -m pip install jinja2
      python build_tools/azure/render_meta.py
    displayName: 'Rendering meta.yaml file'

  - bash: |
      source activate build-env
      conda-build --python=$(python.version) conda/
    displayName: 'Building and testing conda distribution'

  - script: |
      source activate build env
      conda install --use-local pmdarima --yes
    displayName: 'Testing conda installation'
