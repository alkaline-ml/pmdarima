steps:
  - powershell: Write-Host "##vso[task.prependpath]$env:CONDA\Scripts"
    displayName: 'Add conda to PATH'

  - script: conda install conda-build anaconda-client --yes
    displayName: 'Installing conda-build and anaconda-client'

  - bash: |
      mkdir conda
      python -m pip install jinja2
      python build_tools/azure/render_meta.py
    displayName: 'Rendering meta.yaml file'

  # Some of our dependencies are not available from conda, so this let's us try conda first, then pip
  # Numpy has to be install before anything or conda complains
  - bash: |
      conda create --name build-env python=$(python.version) --yes
      source activate build-env
      conda install --yes "$(cat requirements.txt | grep numpy)" || pip install "$(cat requirements.txt | grep numpy)"
      while read requirement; do conda install --yes "$requirement" || pip install "$requirement"; done < requirements.txt
      conda-build --python=$(python.version) conda/
    displayName: 'Building and testing conda distribution'

  - script:
      conda install --use-local pmdarima --yes
    displayName: 'Testing conda installation'
