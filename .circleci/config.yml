version: 2.1

# This will trigger on tags AND branches
test-filters: &test-filters
    tags:
        only: /.*/
    branches:
        only: /.*/

# This will ignore for ALL branches, and only trigger on tags
deploy-filters: &deploy-filters
    tags:
        only: /.*/
    branches:
        ignore: /.*/

jobs:
  lint:
    docker:
      - image: python:3.10
    working_directory: ~/pmdarima
    steps:
    - checkout
    - run:
        name: Install requirements
        command: make lint-requirements
    - run:
        name: Test lint
        command: make test-lint

  # Build Linux x86_64 wheels using cibuildwheel
  build-linux-x86:
    parameters:
      python-version:
        type: string
    docker:
      - image: cimg/python:3.12
    working_directory: ~/pmdarima
    steps:
      - checkout
      - setup_remote_docker
      - run:
          name: Install cibuildwheel
          command: python -m pip install cibuildwheel
      - run:
          name: Build wheels for Python << parameters.python-version >>
          command: python -m cibuildwheel --output-dir wheelhouse
          environment:
            CIBW_BUILD: "cp<< parameters.python-version >>-*"
            CIBW_ENVIRONMENT_PASS_LINUX: CIRCLECI CIRCLE_TAG
            CIBW_SKIP: "*-musllinux_* pp*"
            CIBW_ARCHS_LINUX: "x86_64"
            CIBW_BEFORE_TEST: pip install .[test]
            CIBW_TEST_COMMAND: pytest --showlocals --durations=20 --pyargs pmdarima
      - store_artifacts:
          path: ./wheelhouse
      - run:
          name: Create versioned workspace
          command: mkdir -p cp<< parameters.python-version >> && cp -R wheelhouse cp<< parameters.python-version >>/
      - persist_to_workspace:
          root: cp<< parameters.python-version >>
          paths:
            - wheelhouse

  # Build documentation
  build-doc:
    docker:
      - image: alkalineml/pmdarima-doc-base:latest
    working_directory: ~/pmdarima
    steps:
      - checkout
      - run: ./build_tools/circle/build_doc.sh
      - persist_to_workspace:
          root: doc
          paths:
            - _build/html

  # Simple job that passes when all other tests have passed
  testing-passed:
    docker:
      - image: bash:latest
    steps:
      - run:
          name: pmdarima Testing passed
          command: echo "All tests passed"

  # Deploy wheels to PyPI
  deploy-to-pypi:
    machine:
      image: ubuntu-2004:2024.01.1
    working_directory: ~/pmdarima
    steps:
      - checkout
      - attach_workspace:
          at: cp310
      - attach_workspace:
          at: cp311
      - attach_workspace:
          at: cp312
      - attach_workspace:
          at: cp313
      - run:
          name: Collect all wheels into dist directory
          command: |
            mkdir -p dist
            cp cp310/wheelhouse/* dist/ || true
            cp cp311/wheelhouse/* dist/ || true
            cp cp312/wheelhouse/* dist/ || true
            cp cp313/wheelhouse/* dist/ || true
      - run:
          name: Deploy to PyPI
          command: |
            env > vars.env
            docker run --rm -it \
              -v `pwd`:/app \
              -w /app \
              --env-file vars.env \
              python:3.11 \
              ./build_tools/circle/deploy.sh

  # Deploy documentation
  deploy-doc:
    docker:
      - image: python:3.11
    working_directory: ~/pmdarima
    steps:
      - checkout
      - attach_workspace:
          at: doc
      - run: ./build_tools/circle/deploy_doc.sh

workflows:
  version: 2
  pmdarima-pipeline:
    jobs:
        # Test and build jobs (run on all branches and tags)
        - lint:
            filters: *test-filters
        - build-linux-x86:
            name: build-linux-x86-cp<< matrix.python-version >>
            matrix:
              parameters:
                python-version: ["310", "311", "312", "313"]
            filters: *test-filters
        - build-doc:
            filters: *test-filters
        - testing-passed:
            requires:
                - lint
                - build-linux-x86-cp310
                - build-linux-x86-cp311
                - build-linux-x86-cp312
                - build-linux-x86-cp313
                - build-doc
            filters: *test-filters

        # Deployment jobs (run only on tags)
        - deploy-doc:
            requires:
                - testing-passed
            filters: *deploy-filters

        - deploy-to-pypi:
            requires:
                - testing-passed
            filters: *deploy-filters
