name: Test against latest dependencies

# Run if we change any of these paths and every night at 1 (or 2) AM Central time
on:
  push:
    branches-ignore:
      - 'master'
    paths:
    - 'requirements.txt'
    - '.github/workflows/nightly_cron.yml'

  schedule:
    - cron: '0 7 * * *'  # Every day at 07:00 UTC (1AM CST or 2AM CDT)

jobs:
  build:
    name: Build against latest dependencies
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, macos-latest, ubuntu-latest]
        python-version: ['3.5', '3.6', '3.7', '3.8']
        architecture: ['x86', 'x64']
        exclude:
          # Don't build 32-bit on Mac or Linux
          - os: macos-latest
            architecture: x86

          - os: ubuntu-latest
            architecture: x86

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@master

      # Visual Studio 2019 (windows-latest) doesn't include these files for some reason??
      # Even stranger, it really only affects Python 3.5, but we run it across all versions for consistency
      # https://social.msdn.microsoft.com/Forums/vstudio/en-US/06675e6d-9a0b-46f5-8de0-10237fab1ece/link-error-lnk1158?forum=vcgeneral
      - name: Fix Windows
        if: matrix.os == 'windows-latest'
        run: |
          Copy-Item "C:\Program Files (x86)\Windows Kits\10\bin\10.0.18362.0\x86\rc.exe" -Destination "C:\Program Files (x86)\Microsoft Visual Studio 14.0\VC\BIN"
          Copy-Item "C:\Program Files (x86)\Windows Kits\10\bin\10.0.18362.0\x86\rcdll.dll" -Destination "C:\Program Files (x86)\Microsoft Visual Studio 14.0\VC\BIN"
        shell: powershell

      - name: Setting up Python
        uses: actions/setup-python@v1.1.1
        with:
          python-version: ${{ matrix.python-version }}
          architecture: ${{ matrix.architecture }}

      - name: Updating pip
        run: python -m pip install --upgrade pip
        shell: bash

      - name: Collecting dependencies
        id: dependencies  # Needed to retrieve the output of this step later
        run: |
          dependencies=$(python build_tools/github/get_latest_dependencies.py)
          echo "::set-output name=latest_dependencies::${dependencies}"
        shell: bash

      - name: Checking output
        run: |
          for item in $DEPENDENCIES; do
            echo $item
          done
        env:
          DEPENDENCIES: ${{ steps.dependencies.outputs.latest_dependencies }}